<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JaseCamp</title>

    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Bitter:700' rel='stylesheet' type='text/css'>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAVrNo-BLFdMvXJCL8LyO6VNqlw7Q-Pae0",
            authDomain: "jasecamp-9c009.firebaseapp.com",
            databaseURL: "https://jasecamp-9c009.firebaseio.com",
            storageBucket: "jasecamp-9c009.appspot.com",
        };
        firebase.initializeApp(config);
        //console.log(firebase.database().ref('team').push({'name':'Portable','projects':[]}));

        // TODO: Replace hardcorded team with team from '/access' object
        var projects =firebase.database().ref('team/-KN-RchlyeUsxGN-Zkvb/projects');

        projects.on('child_added', function() {
            console.log('New Project');
        });
        projects.on('child_removed', function() {
            console.log('Project Removed');
        });

        // Reload on version change to public displays
        var appVersion = null;
        firebase.database().ref('version').on('value', function(snapshot) {
            if(appVersion == null) {
                appVersion = snapshot.val();
                $('#version').text(appVersion);
            } else {
                document.location.href = document.location.href+'?'+snapshot.val();
            }
        });

    </script>

    <script type="text/javascript">
        /**
         * Function called when clicking the Login/Logout button.
         */
        // [START buttoncallback]
        function toggleSignIn() {
            if (!firebase.auth().currentUser) {
                var provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/plus.login');
                firebase.auth().signInWithPopup(provider).then(function (result) {
                    var token = result.credential.accessToken;
                    var user = result.user;
                    document.getElementById('quickstart-oauthtoken').textContent = token;
                }).catch(function (error) {
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    var email = error.email;
                    var credential = error.credential;
                    if (errorCode === 'auth/account-exists-with-different-credential') {
                        alert('You have already signed up with a different auth provider for that email.');
                    } else {
                        console.error(error);
                    }
                });
            } else {
                firebase.auth().signOut();
            }
        }
        /**
         * initApp handles setting up the Firebase context and registering
         * callbacks for the auth status.
         *
         * The core initialization is in firebase.App - this is the glue class
         * which stores configuration. We provide an app name here to allow
         * distinguishing multiple app instances.
         *
         * This method also registers a listener with firebase.auth().onAuthStateChanged.
         * This listener is called when the user is signed in or out, and that
         * is where we update the UI.
         *
         * When signed in, we also authenticate to the Firebase Realtime Database.
         */
        function initApp() {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    //$('#login').hide();
                    $('#quickstart-sign-in').text('Sign Out - ' + user.displayName)
                    $('#projects').show();

                    // User is signed in.
                    var displayName = user.displayName;
                    var email = user.email;
                    var emailVerified = user.emailVerified;
                    var photoURL = user.photoURL;
                    var isAnonymous = user.isAnonymous;
                    var uid = user.uid;

                    //console.log(firebase.database().ref('access/'+user.uid).push('-KN-RchlyeUsxGN-Zkvb'));

                    var refreshToken = user.refreshToken;
                    var providerData = user.providerData;
                    document.getElementById('quickstart-sign-in-status').textContent = 'Signed in';
                    document.getElementById('quickstart-sign-in').textContent = 'Sign out';
                    document.getElementById('quickstart-account-details').textContent = JSON.stringify({
                        displayName: displayName,
                        email: email,
                        emailVerified: emailVerified,
                        photoURL: photoURL,
                        isAnonymous: isAnonymous,
                        uid: uid,
                        refreshToken: refreshToken,
                        providerData: providerData
                    }, null, '  ');


//                    firebase.database().ref('/access/'+user.uid).once('value').then(function(snapshot) {
//                        console.log('data', snapshot.val())
//                    });



                } else {
                    // User is signed out.
                    $('#quickstart-sign-in').text('Sign In with Google')
                    //$('#login').show();
                    $('#projects').hide();
                }
                document.getElementById('quickstart-sign-in').disabled = false;
            });
            $('#quickstart-sign-in').on('click', toggleSignIn);
        }
        $(document).ready(function () {
            initApp();
        });
        function version(v) {
            firebase.database().ref('version').set(v);
        }
    </script>
    <style>
        /*#ECB200, #CB2C1A, #ADC800*/

        header {
            background-color: #CB2C1A;
            color: #fff;
            box-shadow: 0px -2px 21px #000;
        }
        header h1 {
            margin: 10px 0 12px 0;
            font-family: 'Bitter', serif;
            font-size: 32px;
        }
        header .btn {
            margin: 12px 0 0 0;
        }
        footer {
            position: fixed;
            bottom: 0px;
            left: 0px;
            right: 0px;
            background-color: #ECB200;
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <button disabled class="btn btn-default pull-right" id="quickstart-sign-in">Sign in with
            Google
        </button>
        <h1>JaseCamp</h1>
    </div>
</header>
<div class="container">
    <div id="projects">
        <table class="table table-stripped">
            <thead>
            <tr>
                <th>Project</th>
                <th>Delivery Date</th>
                <th>Internal Date</th>
                <th>Internal Deliverable</th>
                <th>Who</th>
                <th>Comms</th>
            </tr>
            </thead>
            <tbody id="project-list">

            </tbody>
        </table>
    </div>
</div>
<footer>
    <div class="container">
        <p>Version <span id="version"></span></p>
    </div>
</footer>

</body>
</html>